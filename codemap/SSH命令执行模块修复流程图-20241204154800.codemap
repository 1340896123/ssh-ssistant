{
  "schemaVersion": "1.0",
  "id": "ssh-command-execution-fix-flow",
  "metadata": {
    "created": "2024-12-04T15:48:00Z",
    "version": "1.0.0",
    "description": "SSHå‘½ä»¤æ‰§è¡Œæ¨¡å— deadlocké£é™©å’Œå–æ¶ˆæœºåˆ¶é—®é¢˜çš„ä¿®å¤æµç¨‹å›¾",
    "project": "ssh-ssistant",
    "severity": "High",
    "components": ["ssh.rs", "AIAssistant.vue", "AppState"]
  },
  "title": "SSHå‘½ä»¤æ‰§è¡Œæ¨¡å—ä¿®å¤æµç¨‹å›¾",
  "traces": [
    {
      "id": "trace-1",
      "title": "å½“å‰é—®é¢˜åˆ†æ - Sessionçº§Deadlocké£é™©",
      "description": "åˆ†æexec_commandå‡½æ•°ä¸­mutexé”å¯¼è‡´çš„deadlocké£é™©",
      "locations": [
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1854,
          "lineContent": "pub async fn exec_command(",
          "title": "é—®é¢˜å…¥å£ç‚¹",
          "description": "exec_commandå‡½æ•°æ˜¯å‘½ä»¤æ‰§è¡Œçš„å…¥å£ï¼Œå­˜åœ¨æ½œåœ¨çš„é”æŒæœ‰é—®é¢˜"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1878,
          "lineContent": "let bg_session = client.ssh_pool.get_background_session()",
          "title": "è·å–åå°ä¼šè¯",
          "description": "è·å–åå°ä¼šè¯ç”¨äºæ‰§è¡Œå‘½ä»¤"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1882,
          "lineContent": "let sess = bg_session.lock().map_err(|e| e.to_string())?;",
          "title": "å…³é”®é—®é¢˜ç‚¹",
          "description": "åœ¨æ•´ä¸ªå‘½ä»¤æ‰§è¡ŒæœŸé—´æŒæœ‰background_session mutexé”ï¼Œé˜»å¡å…¶ä»–æ–‡ä»¶æ“ä½œ"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1884,
          "lineContent": "let mut channel = block_on(|| sess.channel_session()).map_err(|e| e.to_string())?;",
          "title": "åˆ›å»ºå‘½ä»¤é€šé“",
          "description": "åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹åˆ›å»ºSSHé€šé“"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1888,
          "lineContent": "loop {",
          "title": "é˜»å¡å¾ªç¯",
          "description": "åœ¨æ•´ä¸ªå‘½ä»¤è¾“å‡ºè¯»å–å¾ªç¯ä¸­æŒç»­æŒæœ‰mutexé”"
        }
      ],
      "traceTextDiagram": "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                  Sessionçº§Deadlocké£é™©åˆ†æ                      â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                                                             â”‚\nâ”‚  exec_command() å¼€å§‹                                         â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  è·å–background_session [è·å–ä¼šè¯]                           â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  ğŸ”’ é”å®š mutex.lock() [âš ï¸ é—®é¢˜ç‚¹]                           â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  åˆ›å»ºSSHé€šé“ channel_session()                              â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  æ‰§è¡Œå‘½ä»¤ channel.exec(command)                             â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  ğŸ”„ è¯»å–è¾“å‡ºå¾ªç¯ (é•¿æ—¶é—´æŒæœ‰é”)                              â”‚\nâ”‚  â”‚  â”Œâ”€ æ£€æŸ¥å–æ¶ˆæ ‡å¿—                                          â”‚\nâ”‚  â”‚  â””â”€ è¯»å–channelæ•°æ®                                      â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  âŒ é˜»å¡å…¶ä»–æ–‡ä»¶æ“ä½œ (SFTPã€ä¸Šä¼ ä¸‹è½½ç­‰)                       â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  é‡Šæ”¾é” [å‘½ä»¤å®Œæˆæˆ–é”™è¯¯æ—¶]                                   â”‚\nâ”‚                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
      "traceGuide": {
        "motivation": "è§£å†³exec_commandå‡½æ•°é•¿æ—¶é—´æŒæœ‰background_session mutexé”å¯¼è‡´çš„deadlocké£é™©ï¼Œè¯¥é—®é¢˜ä¼šé˜»å¡æ‰€æœ‰æ–‡ä»¶æ“ä½œï¼ˆSFTPã€ä¸Šä¼ ä¸‹è½½ç­‰ï¼‰ï¼Œä¸¥é‡å½±å“ç³»ç»Ÿå¹¶å‘æ€§èƒ½ã€‚",
        "details": "å½“å‰å®ç°åœ¨å‘½ä»¤æ‰§è¡Œçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­æŒæœ‰mutexé”ï¼ŒåŒ…æ‹¬ï¼š\n1. SSHé€šé“åˆ›å»º\n2. å‘½ä»¤æ‰§è¡Œ\n3. è¾“å‡ºè¯»å–å¾ªç¯\n\nè¿™å¯¼è‡´ï¼š\n- æ–‡ä»¶æ“ä½œæ— æ³•è·å–åå°ä¼šè¯\n- SFTPæ“ä½œè¢«é˜»å¡\n- ä¸Šä¼ ä¸‹è½½åŠŸèƒ½ä¸å¯ç”¨\n- ç”¨æˆ·ä½“éªŒä¸¥é‡å—æŸ\n\nå…³é”®æŠ€æœ¯ï¼š\n- ä½¿ç”¨Arc<Session>æ›¿ä»£Arc<Mutex<Session>>\n- å¼•ç”¨è®¡æ•°ç®¡ç†ä¼šè¯ç”Ÿå‘½å‘¨æœŸ\n- å¼‚æ­¥ä»»åŠ¡åˆ†ç¦»é”ç®¡ç†"
      }
    },
    {
      "id": "trace-2",
      "title": "å‘½ä»¤å–æ¶ˆæœºåˆ¶é€»è¾‘ç¼ºé™·",
      "description": "åˆ†æä½¿ç”¨Session IDè€ŒéCommand IDä½œä¸ºå–æ¶ˆé”®çš„é—®é¢˜",
      "locations": [
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 168,
          "lineContent": "pub command_cancellations: Mutex<HashMap<String, Arc<AtomicBool>>>, // Session ID -> CancelFlag",
          "title": "é—®é¢˜æ•°æ®ç»“æ„",
          "description": "ä½¿ç”¨Session IDä½œä¸ºkeyï¼Œæ— æ³•ç²¾ç¡®æ§åˆ¶å•ä¸ªå‘½ä»¤çš„å–æ¶ˆ"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1874,
          "lineContent": "cancellations.insert(id.clone(), cancel_flag.clone());",
          "title": "é”™è¯¯é”®å€¼ä½¿ç”¨",
          "description": "ä½¿ç”¨session idè€Œécommand idæ’å…¥å–æ¶ˆæ ‡å¿—"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1839,
          "lineContent": "pub async fn cancel_command_execution(",
          "title": "å–æ¶ˆå‡½æ•°å®ç°",
          "description": "å–æ¶ˆå‡½æ•°åªèƒ½æŒ‰sessionå–æ¶ˆï¼Œæ— æ³•ç²¾ç¡®åˆ°å…·ä½“å‘½ä»¤"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1890,
          "lineContent": "if cancel_flag.load(Ordering::Relaxed) {",
          "title": "å–æ¶ˆæ£€æŸ¥ç‚¹",
          "description": "åœ¨æ‰§è¡Œå¾ªç¯ä¸­æ£€æŸ¥å–æ¶ˆæ ‡å¿—"
        }
      ],
      "traceTextDiagram": "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                å‘½ä»¤å–æ¶ˆæœºåˆ¶é€»è¾‘ç¼ºé™·åˆ†æ                          â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                                                             â”‚\nâ”‚  å½“å‰å®ç°ï¼š                                                  â”‚\nâ”‚                                                             â”‚\nâ”‚  AppState.command_cancellations                              â”‚\nâ”‚  HashMap<SessionID, CancelFlag>  [âš ï¸ é”™è¯¯é”®è®¾è®¡]              â”‚\nâ”‚                                                             â”‚\nâ”‚  æ‰§è¡Œæµç¨‹ï¼š                                                  â”‚\nâ”‚                                                             â”‚\nâ”‚  exec_command(session_id, command)                           â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  åˆ›å»º cancel_flag                                            â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  ğŸ”‘ insert(session_id, cancel_flag) [ä½¿ç”¨session id]         â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  æ‰§è¡Œå‘½ä»¤...                                                 â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  ğŸš« é—®é¢˜ï¼šåŒä¸€sessionçš„å¤šä¸ªå‘½ä»¤äº’ç›¸å¹²æ‰°                         â”‚\nâ”‚  â”Œâ”€ æ— æ³•ç²¾ç¡®å–æ¶ˆå•ä¸ªå‘½ä»¤                                      â”‚\nâ”‚  â””â”€ æ–°å‘½ä»¤ä¼šè¦†ç›–æ—§å‘½ä»¤çš„å–æ¶ˆæ ‡å¿—                              â”‚\nâ”‚                                                             â”‚\nâ”‚  æ­£ç¡®è®¾è®¡ï¼š                                                  â”‚\nâ”‚                                                             â”‚\nâ”‚  HashMap<CommandID, CancelFlag>                             â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  ğŸ”‘ insert(command_id, cancel_flag) [ä½¿ç”¨command id]         â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â–¼                                                    â”‚\nâ”‚  âœ… ç²¾ç¡®æ§åˆ¶æ¯ä¸ªå‘½ä»¤çš„å–æ¶ˆ                                    â”‚\nâ”‚                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
      "traceGuide": {
        "motivation": "ä¿®å¤å‘½ä»¤å–æ¶ˆæœºåˆ¶ä¸­ä½¿ç”¨Session IDè€ŒéCommand IDçš„é€»è¾‘ç¼ºé™·ï¼Œå®ç°ç²¾ç¡®çš„å‘½ä»¤çº§å–æ¶ˆæ§åˆ¶ã€‚",
        "details": "å½“å‰é—®é¢˜ï¼š\n1. ä½¿ç”¨Session IDä½œä¸ºå–æ¶ˆé”®ï¼ŒåŒä¸€ä¼šè¯çš„å¤šä¸ªå‘½ä»¤ä¼šäº’ç›¸å¹²æ‰°\n2. æ–°å‘½ä»¤æ‰§è¡Œä¼šè¦†ç›–æ—§å‘½ä»¤çš„å–æ¶ˆæ ‡å¿—\n3. æ— æ³•ç²¾ç¡®æ§åˆ¶å•ä¸ªå‘½ä»¤çš„å–æ¶ˆ\n4. å‰ç«¯ä¼ é€’tool_call_idä½†åç«¯æœªä½¿ç”¨\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä¿®æ”¹AppStateæ•°æ®ç»“æ„ï¼Œä½¿ç”¨CommandIDä½œä¸ºkey\n2. åœ¨exec_commandä¸­ä½¿ç”¨tool_call_idç”Ÿæˆå”¯ä¸€å‘½ä»¤ID\n3. ä¿®æ”¹cancel_command_executionæ¥æ”¶command_idå‚æ•°\n4. å®ç°å‘½ä»¤å®Œæˆåçš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶"
      }
    },
    {
      "id": "trace-3",
      "title": "é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ³„æ¼é—®é¢˜",
      "description": "åˆ†æé”™è¯¯è·¯å¾„ä¸­ç¼ºå°‘æ¸…ç†é€»è¾‘å¯¼è‡´çš„çŠ¶æ€æ³„æ¼",
      "locations": [
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1923,
          "lineContent": "Err(e) => {",
          "title": "é”™è¯¯å¤„ç†è·¯å¾„",
          "description": "é”™è¯¯è·¯å¾„ä¸­éœ€è¦æ¸…ç†å–æ¶ˆæ ‡å¿—"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1924,
          "lineContent": "// Remove the cancellation flag on error",
          "title": "å·²æœ‰æ¸…ç†é€»è¾‘",
          "description": "å·²ç»æœ‰åŸºæœ¬çš„é”™è¯¯æ¸…ç†ï¼Œä½†ä¸å¤Ÿå®Œå–„"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1894,
          "lineContent": "// Remove the cancellation flag",
          "title": "å–æ¶ˆæ¸…ç†",
          "description": "ç”¨æˆ·å–æ¶ˆæ—¶çš„æ¸…ç†é€»è¾‘"
        }
      ],
      "traceTextDiagram": "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ³„æ¼åˆ†æ                            â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                                                             â”‚\nâ”‚  å½“å‰æ¸…ç†åœºæ™¯ï¼š                                              â”‚\nâ”‚                                                             â”‚\nâ”‚  exec_command()                                             â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â”œâ”€ æˆåŠŸå®Œæˆ âœ…                                           â”‚\nâ”‚       â”‚  â””â”€ cancellations.remove(&id)                        â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â”œâ”€ ç”¨æˆ·å–æ¶ˆ âœ…                                           â”‚\nâ”‚       â”‚  â””â”€ cancellations.remove(&id)                        â”‚\nâ”‚       â”‚                                                    â”‚\nâ”‚       â””â”€ é”™è¯¯æƒ…å†µ âœ…                                           â”‚\nâ”‚          â””â”€ cancellations.remove(&id)                        â”‚\nâ”‚                                                             â”‚\nâ”‚  ğŸ¤” æ½œåœ¨é—®é¢˜ï¼š                                               â”‚\nâ”‚                                                             â”‚\nâ”‚  1. å¦‚æœexec_commandè¢«panicä¸­æ–­                               â”‚\nâ”‚  2. å¦‚æœè¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢                                          â”‚\nâ”‚  3. å¦‚æœå­˜åœ¨å¤šä¸ªå¹¶å‘æ‰§è¡Œè·¯å¾„                                   â”‚\nâ”‚                                                             â”‚\nâ”‚  ğŸ›¡ï¸ å¢å¼ºæ–¹æ¡ˆï¼š                                              â”‚\nâ”‚                                                             â”‚\nâ”‚  1. ä½¿ç”¨RAIIæ¨¡å¼è‡ªåŠ¨æ¸…ç†                                      â”‚\nâ”‚  2. æ·»åŠ Drop traitå®ç°                                       â”‚\nâ”‚  3. å®šæ—¶æ¸…ç†è¿‡æœŸæ ‡å¿—                                          â”‚\nâ”‚  4. ä½¿ç”¨Weakå¼•ç”¨é¿å…å¾ªç¯å¼•ç”¨                                   â”‚\nâ”‚                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
      "traceGuide": {
        "motivation": "è™½ç„¶å½“å‰ä»£ç æœ‰åŸºæœ¬çš„é”™è¯¯æ¸…ç†é€»è¾‘ï¼Œä½†éœ€è¦å¢å¼ºæ¸…ç†æœºåˆ¶ä»¥é˜²æ­¢æç«¯æƒ…å†µä¸‹çš„çŠ¶æ€æ³„æ¼ã€‚",
        "details": "å½“å‰æ¸…ç†æœºåˆ¶ç›¸å¯¹å®Œå–„ï¼Œä½†ä»éœ€è€ƒè™‘ï¼š\n1. panicæƒ…å†µä¸‹çš„èµ„æºæ¸…ç†\n2. å¼‚å¸¸ç»ˆæ­¢æ—¶çš„çŠ¶æ€ä¸€è‡´æ€§\n3. é•¿æ—¶é—´è¿è¡Œä¼šè¯çš„å†…å­˜ç´¯ç§¯\n4. å¹¶å‘æ‰§è¡Œåœºæ™¯ä¸‹çš„ç«æ€æ¡ä»¶\n\nå¢å¼ºç­–ç•¥ï¼š\n1. å®ç°RAIIæ¨¡å¼çš„è‡ªåŠ¨æ¸…ç†å™¨\n2. æ·»åŠ å®šæ—¶æ¸…ç†ä»»åŠ¡\n3. ä½¿ç”¨Weakå¼•ç”¨é¿å…å†…å­˜æ³„æ¼\n4. æ·»åŠ æ¸…ç†å¤±è´¥çš„æ—¥å¿—è®°å½•"
      }
    },
    {
      "id": "trace-4",
      "title": "ä¿®å¤æ–¹æ¡ˆå®ç°æµç¨‹",
      "description": "åˆ†æ­¥éª¤å®æ–½ä¿®å¤æ–¹æ¡ˆçš„å…·ä½“æµç¨‹",
      "locations": [
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 30,
          "title": "æ–°å¢æ•°æ®ç»“æ„å®šä¹‰",
          "description": "æ·»åŠ CommandExecutorç»“æ„ä½“å’Œç›¸å…³ç±»å‹"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 165,
          "title": "ä¿®æ”¹AppState",
          "description": "æ›´æ–°command_cancellationsä½¿ç”¨CommandID"
        },
        {
          "path": "src-tauri/src/ssh.rs",
          "lineNumber": 1854,
          "title": "é‡æ„exec_command",
          "description": "å®Œå…¨é‡å†™å‘½ä»¤æ‰§è¡Œé€»è¾‘"
        },
        {
          "path": "src/components/AIAssistant.vue",
          "lineNumber": 255,
          "title": "æ›´æ–°å‰ç«¯è°ƒç”¨",
          "description": "ä¿®æ”¹å–æ¶ˆå‘½ä»¤çš„å‚æ•°ä¼ é€’"
        }
      ],
      "traceTextDiagram": "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                  ä¿®å¤æ–¹æ¡ˆå®æ–½æµç¨‹                               â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                                                             â”‚\nâ”‚  Phase 1: æ•°æ®ç»“æ„é‡æ„                                       â”‚\nâ”‚                                                             â”‚\nâ”‚  1. å®šä¹‰CommandExecutorç»“æ„ä½“                                â”‚\nâ”‚     â”œâ”€ session: Arc<Session>                                â”‚\nâ”‚     â”œâ”€ command_id: String                                   â”‚\nâ”‚     â””â”€ cancel_flag: Arc<AtomicBool>                         â”‚\nâ”‚                                                             â”‚\nâ”‚  2. ä¿®æ”¹AppState.command_cancellations                      â”‚\nâ”‚     â””â”€ HashMap<CommandID, Arc<AtomicBool>>                  â”‚\nâ”‚                                                             â”‚\nâ”‚  Phase 2: æ ¸å¿ƒé€»è¾‘é‡æ„                                       â”‚\nâ”‚                                                             â”‚\nâ”‚  3. é‡æ„exec_commandå‡½æ•°                                     â”‚\nâ”‚     â”œâ”€ ä½¿ç”¨Arc<Session>æ›¿ä»£é”å®š                              â”‚\nâ”‚     â”œâ”€ ç”Ÿæˆå”¯ä¸€command_id                                   â”‚\nâ”‚     â””â”€ å®ç°RAIIè‡ªåŠ¨æ¸…ç†                                      â”‚\nâ”‚                                                             â”‚\nâ”‚  4. ä¿®æ”¹cancel_command_execution                            â”‚\nâ”‚     â””â”€ æ¥æ”¶command_idå‚æ•°                                   â”‚\nâ”‚                                                             â”‚\nâ”‚  Phase 3: å‰ç«¯é€‚é…                                           â”‚\nâ”‚                                                             â”‚\nâ”‚  5. æ›´æ–°AIAssistant.vue                                     â”‚\nâ”‚     â”œâ”€ ä¼ é€’tool_call_idä½œä¸ºcommand_id                        â”‚\nâ”‚     â””â”€ æ›´æ–°å–æ¶ˆé€»è¾‘                                          â”‚\nâ”‚                                                             â”‚\nâ”‚  Phase 4: æµ‹è¯•éªŒè¯                                           â”‚\nâ”‚                                                             â”‚\nâ”‚  6. å¹¶å‘æµ‹è¯•                                                â”‚\nâ”‚  7. å–æ¶ˆåŠŸèƒ½æµ‹è¯•                                            â”‚\nâ”‚  8. é”™è¯¯æ¢å¤æµ‹è¯•                                            â”‚\nâ”‚                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
      "traceGuide": {
        "motivation": "æä¾›ç³»ç»Ÿæ€§çš„ä¿®å¤å®æ–½æ–¹æ¡ˆï¼Œç¡®ä¿åœ¨è§£å†³é—®é¢˜çš„åŒæ—¶ä¿æŒç³»ç»Ÿç¨³å®šæ€§å’Œå‘åå…¼å®¹æ€§ã€‚",
        "details": "å®æ–½ç­–ç•¥ï¼š\n1. **æ¸è¿›å¼é‡æ„**ï¼šå…ˆæ·»åŠ æ–°ç»“æ„ï¼Œå†é€æ­¥æ›¿æ¢æ—§é€»è¾‘\n2. **å‘åå…¼å®¹**ï¼šä¿æŒAPIæ¥å£ä¸å˜ï¼Œå†…éƒ¨å®ç°ä¼˜åŒ–\n3. **å……åˆ†æµ‹è¯•**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯¹åº”çš„æµ‹è¯•éªŒè¯\n4. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯æ¢å¤å’Œå›æ»šæœºåˆ¶\n\nå…³é”®æŠ€æœ¯ç‚¹ï¼š\n- Arc<Session>å®ç°å…±äº«æ‰€æœ‰æƒ\n- RAIIæ¨¡å¼ç¡®ä¿èµ„æºæ¸…ç†\n- UUIDç”Ÿæˆå”¯ä¸€å‘½ä»¤ID\n- AtomicBoolå®ç°æ— é”å–æ¶ˆ\n- Weakå¼•ç”¨é¿å…å¾ªç¯å¼•ç”¨"
      }
    }
  ],
  "mermaidDiagram": "graph TB\n    subgraph \"Frontend Layer\"\n        A1[AIAssistant.vue] --> A2[User Request]\n        A2 --> A3[Generate Command]\n        A3 --> A4[Call exec_command API]\n        A4 --> A5[Pass tool_call_id]\n        A5 --> A6[Monitor Execution]\n        A6 --> A7[User Cancel Request]\n    end\n    \n    subgraph \"API Service Layer\"\n        B1[Tauri Command Handler] --> B2[exec_command Function]\n        B2 --> B3[Generate Command ID]\n        B3 --> B4[Create CommandExecutor]\n        B4 --> B5[Register Cancel Flag]\n        B5 --> B6[Execute Command Async]\n        B6 --> B7[cancel_command_execution]\n        B7 --> B8[Cleanup Resources]\n    end\n    \n    subgraph \"Backend Layer\"\n        C1[SessionSshPool] --> C2[get_background_session]\n        C2 --> C3[Arc<Session> No Lock]\n        C3 --> C4[SSH Channel Creation]\n        C4 --> C5[Command Execution]\n        C5 --> C6[Output Streaming]\n        C6 --> C7[Cancel Flag Check]\n        C7 --> C8[Resource Cleanup]\n        C8 --> C9[Session Management]\n    end\n    \n    subgraph \"Current Issues (Red)\"\n        I1[âŒ Long Mutex Lock] --> I2[âš ï¸ Session ID as Key]\n        I2 --> I3[âš ï¸ State Leakage Risk]\n        I3 --> I4[ğŸš« Blocking File Ops]\n    end\n    \n    subgraph \"Fix Implementation (Green)\"\n        F1[âœ… Arc<Session> Shared] --> F2[âœ… Command ID Key]\n        F2 --> F3[âœ… RAII Auto Cleanup]\n        F3 --> F4[âœ… Non-blocking Ops]\n    end\n    \n    %% Connections\n    A7 --> B7\n    B6 --> C5\n    B8 --> C8\n    \n    %% Issue to Fix Mapping\n    I1 -.-> F1\n    I2 -.-> F2\n    I3 -.-> F3\n    I4 -.-> F4\n    \n    %% Styling\n    classDef frontend fill:#e1f5fe\n    classDef api fill:#f3e5f5\n    classDef backend fill:#e8f5e8\n    classDef issue fill:#ffebee\n    classDef fix fill:#e8f5e8,stroke:#4caf50,stroke-width:3px\n    \n    class A1,A2,A3,A4,A5,A6,A7 frontend\n    class B1,B2,B3,B4,B5,B6,B7,B8 api\n    class C1,C2,C3,C4,C5,C6,C7,C8,C9 backend\n    class I1,I2,I3,I4 issue\n    class F1,F2,F3,F4 fix"
}